# name: function/spatiotemporal/MEOS_Intersects_Temporal_Geometry_String.test
# description: Test TEMPORAL_INTERSECTS_GEOMETRY with string-based temporal geometries
# groups: [Function, MEOS, SpatioTemporal, TemporalGeometry, String]

# Test 1: Multiple temporal geometry intersect operations
Source trajectories UINT32 id VARSIZED geom1 VARSIZED geom2 INLINE
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9847 40.7494)@2021-01-01 00:00:00'
1,'SRID=4326;POINT(-73.9867 40.7494)@2021-01-01 00:10:00','SRID=4326;POINT(-73.9857 40.7504)@2021-01-01 00:10:00'
1,'SRID=4326;POINT(-73.9877 40.7504)@2021-01-01 00:20:00','SRID=4326;POINT(-73.9867 40.7514)@2021-01-01 00:20:00'
1,'SRID=4326;POINT(-73.9887 40.7514)@2021-01-01 00:30:00','SRID=4326;POINT(-73.9877 40.7524)@2021-01-01 00:30:00'
2,'SRID=4326;POINT(-73.9800 40.7450)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9790 40.7460)@2021-01-01 00:00:00'
2,'SRID=4326;POINT(-73.9810 40.7460)@2021-01-01 00:10:00','SRID=4326;POINT(-73.9800 40.7470)@2021-01-01 00:10:00'
2,'SRID=4326;POINT(-73.9820 40.7470)@2021-01-01 00:20:00','SRID=4326;POINT(-73.9810 40.7480)@2021-01-01 00:20:00'
2,'SRID=4326;POINT(-73.9830 40.7480)@2021-01-01 00:30:00','SRID=4326;POINT(-73.9820 40.7490)@2021-01-01 00:30:00'

SINK intersect_results UINT32 trajectories$id INT32 trajectories$intersects1 INT32 trajectories$intersects2

SELECT id, 
       TEMPORAL_INTERSECTS_GEOMETRY(geom1, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS intersects1,
       TEMPORAL_INTERSECTS_GEOMETRY(geom2, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS intersects2
FROM trajectories
INTO intersect_results
----
1,1,0
1,-1,-1
1,-1,-1
1,-1,-1
2,0,0
2,-1,-1
2,-1,-1
2,-1,-1

# Test 2: Mixed temporal and static geometries
Source mixed_data UINT32 obj_id VARSIZED temporal_geom VARSIZED static_geom INLINE
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9855 40.7483)'
1,'SRID=4326;POINT(-73.9867 40.7494)@2021-01-01 00:05:00','SRID=4326;POINT(-73.9865 40.7493)'
1,'SRID=4326;POINT(-73.9877 40.7504)@2021-01-01 00:10:00','SRID=4326;POINT(-73.9875 40.7503)'
2,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9798 40.7449)'
2,'SRID=4326;POINT(-73.9810 40.7460)@2021-01-01 00:05:00','SRID=4326;POINT(-73.9808 40.7459)'
2,'SRID=4326;POINT(-73.9820 40.7470)@2021-01-01 00:10:00','SRID=4326;POINT(-73.9818 40.7469)'
3,'SRID=4326;POINT(-73.9900 40.7500)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9898 40.7499)'
3,'SRID=4326;POINT(-73.9910 40.7510)@2021-01-01 00:05:00','SRID=4326;POINT(-73.9908 40.7509)'
3,'SRID=4326;POINT(-73.9920 40.7520)@2021-01-01 00:10:00','SRID=4326;POINT(-73.9918 40.7519)'

SINK mixed_results UINT32 mixed_data$obj_id INT32 mixed_data$temporal_intersect INT32 mixed_data$static_intersect

SELECT obj_id,
       TEMPORAL_INTERSECTS_GEOMETRY(temporal_geom, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS temporal_intersect,
       TEMPORAL_INTERSECTS_GEOMETRY('SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00', static_geom) AS static_intersect
FROM mixed_data
INTO mixed_results
----
1,1,-1
1,-1,-1
1,-1,-1
2,1,-1
2,-1,-1
2,-1,-1
3,0,-1
3,-1,-1
3,-1,-1

# Test 3: Multiple geometry checks with same coordinates
Source multi_checks UINT32 traj_id VARSIZED geom1 VARSIZED geom2 INLINE
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00','SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00'
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:01:00','SRID=4326;POINT(-73.9858 40.7485)@2021-01-01 00:01:00'
2,'SRID=4326;POINT(-73.9859 40.7486)@2021-01-01 00:02:00','SRID=4326;POINT(-73.9860 40.7487)@2021-01-01 00:02:00'
2,'SRID=4326;POINT(-73.9861 40.7488)@2021-01-01 00:03:00','SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:03:00'
3,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:04:00','SRID=4326;POINT(-73.9900 40.7500)@2021-01-01 00:04:00'
3,'SRID=4326;POINT(-73.9910 40.7510)@2021-01-01 00:05:00','SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:05:00'

SINK multi_check_results UINT32 multi_checks$traj_id INT32 multi_checks$check1 INT32 multi_checks$check2

SELECT traj_id,
       TEMPORAL_INTERSECTS_GEOMETRY(geom1, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS check1,
       TEMPORAL_INTERSECTS_GEOMETRY(geom2, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS check2
FROM multi_checks
INTO multi_check_results
----
1,1,1
1,-1,-1
2,-1,-1
2,-1,-1
3,-1,-1
3,-1,-1

# Test 4: Simple temporal points for validation
Source validation_points UINT32 sensor_id VARSIZED geometry_wkt UINT32 status INLINE
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00',1
2,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:01:00',0
3,'SRID=4326;POINT(-73.9860 40.7487)@2021-01-01 00:02:00',1
4,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:03:00',1
5,'SRID=4326;POINT(-73.9900 40.7500)@2021-01-01 00:04:00',0

SINK validation_results UINT32 validation_points$sensor_id INT32 validation_points$intersects UINT32 validation_points$status_check

SELECT sensor_id,
       TEMPORAL_INTERSECTS_GEOMETRY(geometry_wkt, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS intersects,
       status AS status_check
FROM validation_points
INTO validation_results
----
1,1,1
2,-1,0
3,-1,1
4,-1,1
5,-1,0

# Test 5: Sequential temporal points 
Source sequential_points UINT32 point_id VARSIZED geometry_wkt INLINE
1,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00'
2,'SRID=4326;POINT(-73.9858 40.7485)@2021-01-01 00:01:00'
3,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:02:00'
4,'SRID=4326;POINT(-73.9860 40.7487)@2021-01-01 00:03:00'
5,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:04:00'
6,'SRID=4326;POINT(-73.9862 40.7489)@2021-01-01 00:05:00'
7,'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:06:00'

SINK sequential_results UINT32 sequential_points$point_id INT32 sequential_points$is_match UINT32 sequential_points$match_count

SELECT point_id,
       TEMPORAL_INTERSECTS_GEOMETRY(geometry_wkt, 'SRID=4326;POINT(-73.9857 40.7484)@2021-01-01 00:00:00') AS is_match,
       point_id AS match_count
FROM sequential_points
INTO sequential_results
----
1,1,1
2,-1,2
3,-1,3
4,-1,4
5,-1,5
6,-1,6
7,-1,7