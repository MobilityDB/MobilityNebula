# Real-time Brake Pressure Monitoring Query Configuration
# This query monitors PCFA and PCFF variance in real-time from TCP stream

# SQL Query
query: |
  SELECT start, end, PCFA_var, PCFF_var FROM (
      SELECT start, end, VAR(PCFA_mbar) AS PCFA_var, VAR(PCFF_mbar) as PCFF_var 
      FROM gps_data
      WINDOW SLIDING(time_utc, SIZE 10 SEC, ADVANCE BY 5 SEC)
  ) WHERE (PCFA_var > FLOAT64(0.4)) and (PCFF_var <= FLOAT64(0.1))
  INTO brake_alerts_stream;

# Sink Configuration
sink:
  name: brake_alerts_stream          # must match the stream in the SQL INTO-clause
  type: MQTT                         # use the MQTT sink implementation
  config:
    serverURI: "tcp://192.168.234.190:1883"   # Mac host IP address
    clientId: "brake_alerts_${START_TIME_EPOCH}"  # unique id per job
    topic: "train/brake/alerts"      # choose any topic hierarchy you like
    qos: 0                             # 0 = at-most-once (fastest, no ACK)
    inputFormat: CSV                   # format for output data (CSV or JSON)

# Logical Source Definition
logical:
  - name: gps_data
    schema:
      - name: time_utc
        type: UINT64
      - name: device_id
        type: UINT64
      - name: Vbat
        type: FLOAT64
      - name: PCFA_mbar
        type: FLOAT64
      - name: PCFF_mbar
        type: FLOAT64
      - name: PCF1_mbar
        type: FLOAT64
      - name: PCF2_mbar
        type: FLOAT64
      - name: T1_mbar
        type: FLOAT64
      - name: T2_mbar
        type: FLOAT64
      - name: Code1
        type: FLOAT64
      - name: Code2
        type: FLOAT64
      - name: gps_speed
        type: FLOAT64
      - name: gps_lat
        type: FLOAT64
      - name: gps_lon
        type: FLOAT64

# Physical Source Configuration for TCP Stream
physical:
  - logical: gps_data
    sourceConfig:
      type: TCP
      socketHost: 192.168.234.190
      socketPort: 9000
      socketDomain: AF_INET
      socketType: SOCK_STREAM
      socketBufferSize: 8192
      flushIntervalMS: 100
      connectTimeoutSeconds: 60
    parserConfig:
      type: CSV
      delimiter: ","